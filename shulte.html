<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>èˆ’å°”ç‰¹æ–¹æ ¼è®­ç»ƒ â€” æœ€ç»ˆç‰ˆ</title>
<style>
  :root{--cell-size:60px;--gap:10px}
  *{box-sizing:border-box}
  body{
    margin:0;min-height:100vh;
    display:flex;align-items:center;justify-content:center;
    font-family:"Microsoft Yahei",Arial,Helvetica,sans-serif;
    background:linear-gradient(135deg,#eef6ff,#ffffff);
    padding:20px;
  }
  .wrap{width:100%;max-width:980px;text-align:center}
  h1{margin:0 0 10px;color:#111;font-size:22px}
  #top-stats{display:flex;gap:20px;justify-content:center;align-items:center;margin-bottom:12px;flex-wrap:wrap;color:#333}
  .stat{font-size:15px}
  #controls, #menu{margin-bottom:10px}
  .btn{margin:6px;padding:8px 14px;background:#3b82f6;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:14px}
  .btn.secondary{background:#6b7280}
  .btn.ghost{background:transparent;color:#3b3b3b;border:1px solid #ddd}
  .mode-select{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-bottom:8px}
  #game-wrapper{display:flex;justify-content:center}
  #game{display:grid;gap:var(--gap);justify-content:center;align-items:center}
  .cell{
    width:var(--cell-size);height:var(--cell-size);display:flex;align-items:center;justify-content:center;
    background:#fff;border-radius:10px;font-size:20px;cursor:pointer;user-select:none;
    box-shadow:0 4px 10px rgba(0,0,0,0.06);transition:transform .08s,background .12s;
  }
  .cell:active{transform:scale(.98)}
  .cell.correct{background:#c6f6d5;color:#055;font-weight:700}
  .cell.wrong{background:#ffd6d6;color:#900}
  .cell.dim{opacity:.6}
  #timer{margin-top:8px;font-weight:700;color:#333}
  #result{margin-top:8px;min-height:22px;font-size:15px;color:#222}
  #record-container{margin-top:18px;text-align:left;margin-left:auto;margin-right:auto;max-width:520px}
  #record-container h3{margin:6px 0}
  #record-list{list-style:none;padding:0;margin:0}
  #record-list li{display:flex;justify-content:space-between;align-items:center;background:#fff;border-radius:8px;padding:8px 10px;margin:6px 0;box-shadow:0 3px 8px rgba(0,0,0,0.04);font-size:14px}
  .record-meta{color:#333}
  .del{background:#ef4444;border:none;color:#fff;padding:6px 8px;border-radius:6px;cursor:pointer;font-size:12px}
  .rating-good{color:#16a34a;font-weight:700}
  .rating-mid{color:#f59e0b;font-weight:700}
  .rating-bad{color:#ef4444;font-weight:700}
  .small{font-size:13px;color:#666}
  .grid-opts{display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap;margin-top:6px}
  .checkbox{display:inline-flex;align-items:center;gap:6px}
  .divider{height:1px;background:#eee;margin:12px 0}
  /* responsive */
  @media(max-width:600px){
    :root{--cell-size:46px;--gap:8px}
    h1{font-size:18px}
    .btn{padding:7px 10px;font-size:13px}
    #record-container{max-width:95%}
  }
</style>
</head>
<body>
  <div class="wrap">
    <h1>èˆ’å°”ç‰¹æ–¹æ ¼è®­ç»ƒï¼ˆæœ€ç»ˆç‰ˆï¼‰</h1>

    <div id="top-stats">
      <div class="stat">ğŸ† æœ¬æ¨¡å¼æœ€ä½³ï¼š<span id="best-all">-</span> ç§’</div>
      <div class="stat">ğŸ“… ä»Šæ—¥æœ€ä½³ï¼š<span id="best-today">-</span> ç§’</div>
    </div>

    <!-- æ¨¡å¼ä¸æŒ‘æˆ˜é€‰æ‹© -->
    <div id="menu">
      <div class="mode-select">
        <button class="btn" data-mode="3x3" onclick="prepareMode('3x3')">3 Ã— 3</button>
        <button class="btn" data-mode="4x4" onclick="prepareMode('4x4')">4 Ã— 4</button>
        <button class="btn" data-mode="5x5" onclick="prepareMode('5x5')">5 Ã— 5</button>
        <button class="btn" data-mode="challenge" onclick="openChallenge()">æŒ‘æˆ˜æ¨¡å¼</button>
      </div>
      <div id="challenge-panel" style="display:none">
        <div class="grid-opts">
          <label class="checkbox"><input type="checkbox" id="opt-timed"> é™æ—¶ï¼ˆç§’ï¼‰<input id="opt-timed-sec" type="number" value="30" min="5" style="width:70px;margin-left:6px"/></label>
          <label class="checkbox"><input type="checkbox" id="opt-colorful"> éšæœºé¢œè‰²</label>
          <label class="checkbox"><input type="checkbox" id="opt-flash"> é¢œè‰²é—ªçƒï¼ˆç‚¹é”™é—ªåŠ¨ï¼‰</label>
          <label class="checkbox"><input type="checkbox" id="opt-distract"> å¹²æ‰°ï¼ˆåŒå€æ•°å­— / é¢å¤–å¹²æ‰°ï¼‰</label>
        </div>
        <div style="margin-top:8px">
          <button class="btn" onclick="prepareMode('challenge')">å¼€å§‹æŒ‘æˆ˜ï¼ˆä½¿ç”¨æ‰€é€‰é¡¹ï¼‰</button>
          <button class="btn secondary" onclick="closeChallengePanel()">å–æ¶ˆ</button>
        </div>
      </div>
    </div>

    <div id="controls" style="display:none">
      <button class="btn" onclick="resetGrid()">é‡ç½®</button>
      <button class="btn secondary" onclick="goBack()">é‡é€‰</button>
    </div>

    <div id="timer" class="small"></div>
    <div id="game-wrapper"><div id="game" aria-live="polite"></div></div>
    <div id="result"></div>

    <div class="divider"></div>

    <div id="record-container">
      <h3>ğŸ“œ æˆç»©è®°å½•ï¼ˆå½“å‰æ˜¾ç¤ºï¼š<span id="current-mode-label">-</span>ï¼‰</h3>
      <div class="small">æ’è¡Œæ¦œæŒ‰æ¨¡å¼ç‹¬ç«‹å­˜å‚¨ï¼›å¯åˆ é™¤ä»»æ„æ¡ç›®ã€‚</div>
      <ul id="record-list"></ul>
    </div>
<!-- ----------------- å¼€å§‹ï¼šé¡µè„šï¼ˆæµ‹è¯•ç‰ˆæœ¬ / è”ç³»æ–¹å¼ / ä½œè€…ï¼‰ ----------------- -->
	<footer id="site-footer" style="margin-top:18px;padding:12px 0;background:transparent;">
  		<div style="max-width:920px;margin:0 auto;text-align:center;color:#666;font-size:13px;">
    <div>âš ï¸ æœ¬ç½‘ç«™ä¸ºæµ‹è¯•ç‰ˆæœ¬ï¼Œå¦‚æœ‰å»ºè®®å’Œéœ€æ±‚ï¼Œè¯·ç§ä¿¡è°·æ­Œé‚®ç®±ï¼š<a href="mailto:xiuyangmc@gmail.com">xiuyangmc@gmail.com</a>ï¼Œæˆ– QQï¼š<strong>3973017100</strong></div>
    		<div style="margin-top:6px">ä½œè€…ï¼š<strong>Mr_Sheepverse</strong></div>
  			</div>
				</footer>
<!-- ----------------- ç»“æŸï¼šé¡µè„š ----------------- -->
  </div>

<script>
/* =================  çŠ¶æ€ä¸å­˜å‚¨  ================= */
let mode = null;                 // '3x3','4x4','5x5','challenge'
let size = 0;
let seqCurrent = 1;              // å½“å‰åº”ç‚¹æ•°å­—
let startTs = 0;
let running = false;
let timerInterval = null;
let limitRemain = 0;
const STORAGE_KEY = 'sg_leaderboards_v2'; // å­˜å‚¨æ‰€æœ‰æ¨¡å¼çš„æ’è¡Œæ¦œ
// åˆå§‹åŒ– leaderboards ç»“æ„ï¼ˆæ¯ä¸ªæ¨¡å¼æ˜¯æ•°ç»„ï¼‰
const defaultBoards = { '3x3':[], '4x4':[], '5x5':[], 'challenge':[] };
let leaderboards = JSON.parse(localStorage.getItem(STORAGE_KEY) || 'null') || defaultBoards;

/* æ¯æ¨¡å¼çš„æˆç»©é˜ˆå€¼ï¼ˆç§’ï¼‰: [ä¼˜ç§€, è‰¯å¥½, ä¸€èˆ¬] */
const thresholds = {
  '3x3': [2.5, 4.0, 6.0],
  '4x4': [6.0, 10.0, 15.0],
  '5x5': [12.0, 18.0, 26.0],
  'challenge': [8.0, 14.0, 22.0]
};

/* =============== UI/å‡†å¤‡æ¨¡å¼ =============== */
function prepareMode(m){
  mode = m;
  // è®¾ç½®å°ºå¯¸
  if(m === '3x3') size = 3;
  else if(m === '4x4') size = 4;
  else if(m === '5x5') size = 5;
  else if(m === 'challenge'){ 
    // åœ¨æŒ‘æˆ˜æ¨¡å¼ä¸­ï¼Œå¯ä»¥æŒ‰é»˜è®¤ size 5 æˆ–å¯æ ¹æ®é€‰é¡¹è®¾ç½®
    size = 5;
    // apply challenge options from checkboxes: already read in startGame
  }
  document.getElementById('menu').style.display = 'none';
  document.getElementById('challenge-panel').style.display = 'none';
  document.getElementById('controls').style.display = 'block';
  document.getElementById('current-mode-label').textContent = mode;
  document.getElementById('result').textContent = '';
  document.getElementById('timer').textContent = '';
  seqCurrent = 1;
  running = false;
  startTs = 0;
  clearInterval(timerInterval);
  // generate grid using options for challenge
  generateGrid();
  updateTopStats();
  renderRecords();
}

/* challenge panel open/close */
function openChallenge(){
  document.getElementById('challenge-panel').style.display = 'block';
}
function closeChallengePanel(){
  document.getElementById('challenge-panel').style.display = 'none';
}

/* =============== ç”Ÿæˆ/é‡ç½® æ ¼å­ =============== */
function generateGrid(){
  const game = document.getElementById('game');
  game.innerHTML = '';
  const total = size * size;
  // base numbers
  let nums = Array.from({length:total}, (_,i)=>i+1);
  // è‹¥ challenge å¹²æ‰°é€‰é¡¹å¼€å¯ï¼Œå¯èƒ½å¢åŠ å¹²æ‰°å…ƒç´ ï¼ˆä¾‹å¦‚é‡å¤æ•°å­—æ··æ·†ä½ç½®ï¼‰
  const useDistract = (mode === 'challenge') && document.getElementById('opt-distract') && document.getElementById('opt-distract').checked;
  if(useDistract){
    // éšæœºæ›¿æ¢å°‘æ•°æ ¼ä¸ºéšæœºä¸¤ä½æ•°ï¼ˆå¹²æ‰°è§†è§‰ï¼‰æˆ–é‡å¤æ•°
    // ä½†ä¸ºäº†è®¡æ•°é€»è¾‘ä»ç„¶ä»¥ 1..n åˆ¤æ–­ï¼ˆå¹²æ‰°åªæ”¹å˜å±•ç¤ºæ–‡æœ¬ï¼‰
  }

  // æ´—ç‰Œ
  for(let i=nums.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [nums[i], nums[j]] = [nums[j], nums[i]];
  }

  // grid åˆ—æ•°
  document.getElementById('game').style.gridTemplateColumns = `repeat(${size}, var(--cell-size))`;

  // è‹¥ challenge å¹¶é€‰äº†éšæœºé¢œè‰²ï¼Œåˆ™æ¯ä¸ªæ ¼å­èµ‹åˆå§‹é¢œè‰²
  const useColorful = (mode === 'challenge') && document.getElementById('opt-colorful') && document.getElementById('opt-colorful').checked;
  const useFlash = (mode === 'challenge') && document.getElementById('opt-flash') && document.getElementById('opt-flash').checked;

  for(let k=0;k<nums.length;k++){
    const n = nums[k];
    const cell = document.createElement('div');
    cell.className = 'cell';
    // å¯èƒ½å¹²æ‰°ï¼šå±•ç¤ºæ–‡æœ¬ä¸åŒäºå†…éƒ¨æ•°å­—ï¼ˆä½†å†…éƒ¨åˆ¤æ–­ä»ç”¨ data-numï¼‰
    let displayText = String(n);
    if(useDistract && Math.random() < 0.15){
      // 15% æ¦‚ç‡æ˜¾ç¤ºåŒä½æ•°å¹²æ‰°
      displayText = String(n + (Math.random() < 0.5 ? 10 : -1));
    }
    cell.textContent = displayText;
    // å­˜å‚¨å†…éƒ¨çœŸå®æ•°å­—
    cell.dataset.num = n;
    // éšæœºé¢œè‰²:
    if(useColorful){
      cell.style.background = randomColor();
    }
    // ç‚¹å‡»å¤„ç†
    cell.addEventListener('click', ()=>onCellClick(cell));
    game.appendChild(cell);
  }
  // reset state
  seqCurrent = 1;
  running = false;
  startTs = 0;
  clearInterval(timerInterval);
  document.getElementById('timer').textContent = '';
  document.getElementById('result').textContent = 'ç‚¹å‡»æ•°å­— 1 å¼€å§‹è®¡æ—¶';
}

/* å½»åº•é‡ç½®ï¼ˆç”¨æˆ·ç‚¹å‡» Resetï¼‰â€”â€”ä¿®å¤ä½ é‡åˆ°çš„ bug */
function resetGrid(){
  // ä¿è¯æ‰€æœ‰çŠ¶æ€é‡ç½®ï¼Œé‡å»ºæ ¼å­
  seqCurrent = 1;
  running = false;
  startTs = 0;
  clearInterval(timerInterval);
  document.getElementById('timer').textContent = '';
  document.getElementById('result').textContent = 'å·²é‡ç½®ï¼šç‚¹å‡» 1 å¼€å§‹';
  // é‡æ–°ç”Ÿæˆæ ¼å­ï¼ˆä¿æŒå½“å‰æ¨¡å¼ä¸é€‰é¡¹ï¼‰
  generateGrid();
}

/* è¿”å›ä¸»èœå• */
function goBack(){
  mode = null;
  size = 0;
  seqCurrent = 1;
  running = false;
  clearInterval(timerInterval);
  document.getElementById('menu').style.display = 'block';
  document.getElementById('challenge-panel').style.display = 'none';
  document.getElementById('controls').style.display = 'none';
  document.getElementById('game').innerHTML = '';
  document.getElementById('timer').textContent = '';
  document.getElementById('result').textContent = '';
  document.getElementById('current-mode-label').textContent = '-';
  renderRecords(); // show default
  updateTopStats();
}

/* =============== ç‚¹å‡»é€»è¾‘ =============== */
function onCellClick(cell){
  const num = Number(cell.dataset.num);
  // If already correct, ignore
  if(cell.classList.contains('correct')) return;

  // First click to start timer
  if(!running){
    // if clicked not 1 at the very start, flash wrong but don't start timer
    if(num !== 1){
      flashWrong(cell);
      return;
    }
    running = true;
    startTs = Date.now();
    // If challenge chosen and timed option set, start countdown accordingly
    if(mode === 'challenge' && document.getElementById('opt-timed') && document.getElementById('opt-timed').checked){
      const s = parseInt(document.getElementById('opt-timed-sec').value) || 30;
      startCountdown(s);
    }
    // If mode normal with limit? (not by default)
  }

  // Correct?
  if(num === seqCurrent){
    cell.classList.add('correct');
    // è‹¥ä¸º challenge ä¸”æœ‰é—ªåŠ¨æ•ˆæœï¼Œæ¸…é™¤è¯¥æ ¼çš„é—ªåŠ¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    seqCurrent++;
    // å®Œæˆæ¡ä»¶
    if(seqCurrent > size*size){
      // finished
      const total = ((Date.now() - startTs)/1000).toFixed(2);
      finishAttempt(parseFloat(total));
    }
  } else {
    // wrong
    flashWrong(cell);
  }
}

/* é”™è¯¯çŸ­æš‚åé¦ˆï¼ˆå¦‚æœ challenge flash option æ‰“å¼€ï¼Œåˆ™å…¨å±€é—ªåŠ¨è‰²ï¼‰ */
function flashWrong(cell){
  const useFlash = (mode === 'challenge') && document.getElementById('opt-flash') && document.getElementById('opt-flash').checked;
  if(useFlash){
    // å…¨éƒ¨æ ¼å­çŸ­æ—¶é—ªçº¢
    const cells = document.querySelectorAll('#game .cell');
    cells.forEach(c=>c.classList.add('wrong'));
    setTimeout(()=>cells.forEach(c=>c.classList.remove('wrong')), 200);
  } else {
    cell.classList.add('wrong');
    setTimeout(()=>cell.classList.remove('wrong'), 120);
  }
}

/* =============== è®¡æ—¶/ç»“æŸä¿å­˜ =============== */
function startCountdown(sec){
  clearInterval(timerInterval);
  limitRemain = sec;
  const el = document.getElementById('timer');
  el.textContent = `â° å‰©ä½™ï¼š${limitRemain}s`;
  timerInterval = setInterval(()=>{
    limitRemain--;
    if(limitRemain <= 0){
      clearInterval(timerInterval);
      el.textContent = 'â° æ—¶é—´åˆ°';
      // ä»»åŠ¡å¤±è´¥ï¼Œå›åˆ°èœå•æˆ–é‡ç½®? æˆ‘ä»¬ç›´æ¥æç¤ºå¹¶é‡ç½®å½“å‰ç•Œé¢ï¼ˆä¸ä¿å­˜ï¼‰
      alert('æŒ‘æˆ˜é™æ—¶åˆ°ï¼Œç»“æŸæœ¬æ¬¡æŒ‘æˆ˜ï¼ˆæœªè®¡å…¥æˆç»©ï¼‰');
      goBack();
    } else {
      el.textContent = `â° å‰©ä½™ï¼š${limitRemain}s`;
    }
  },1000);
}

function finishAttempt(total){
  clearInterval(timerInterval);
  running = false;
  document.getElementById('timer').textContent = '';
  const rating = evaluate(mode, total);
  const color = rating.color;
  document.getElementById('result').innerHTML = `âœ… å®Œæˆï¼š<strong>${total.toFixed(2)}</strong> ç§’  <span style="color:${color};font-weight:700">${rating.text}</span>`;
  // ä¿å­˜è®°å½•ï¼ˆæŒ‰æ¨¡å¼å•ç‹¬å­˜ï¼‰
  saveRecord(mode, total);
  renderRecords();
  updateTopStats();
}

/* =============== è¯„çº§ï¼ˆä¸åŒæ¨¡å¼ä¸åŒé˜ˆå€¼ï¼‰ =============== */
function evaluate(m, t){
  const th = thresholds[m] || thresholds['challenge'];
  if(t <= th[0]) return {text:'ä¼˜ç§€', color:'#16a34a'};
  if(t <= th[1]) return {text:'è‰¯å¥½', color:'#0ea5e9'};
  if(t <= th[2]) return {text:'ä¸€èˆ¬', color:'#f59e0b'};
  return {text:'è¿˜éœ€åŠªåŠ›', color:'#ef4444'};
}

/* =============== è®°å½•å­˜å‚¨ï¼ˆæŒ‰æ¨¡å¼ï¼‰ =============== */
function saveRecord(m, time){
  const rec = { time: parseFloat(time.toFixed(2)), date: new Date().toLocaleDateString(), ts: Date.now() };
  if(!leaderboards[m]) leaderboards[m] = [];
  leaderboards[m].push(rec);
  persist();
}

/* åˆ é™¤è®°å½•ï¼ˆæŒ‡å®šæ¨¡å¼å’Œ ts æˆ–ç´¢å¼•ï¼‰ */
function deleteRecordByIdx(m, idx){
  if(!leaderboards[m]) return;
  if(!confirm('ç¡®è®¤åˆ é™¤è¯¥æ¡è®°å½•ï¼Ÿ')) return;
  leaderboards[m].splice(idx,1);
  persist();
  renderRecords();
  updateTopStats();
}

/* å­˜åˆ° localStorage */
function persist(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(leaderboards));
}

/* =============== æ’è¡Œä¸è®°å½•æ˜¾ç¤º =============== */
function renderRecords(){
  const list = document.getElementById('record-list');
  list.innerHTML = '';
  if(!mode){
    list.innerHTML = '<li style="background:transparent;color:#666">è¯·å…ˆé€‰æ‹©æ¨¡å¼æˆ–è¿›å…¥æŒ‘æˆ˜ä»¥æŸ¥çœ‹å¯¹åº”æ’è¡Œã€‚</li>';
    return;
  }
  const records = (leaderboards[mode] || []).slice().sort((a,b)=>a.time - b.time);
  if(records.length === 0){
    list.innerHTML = '<li style="background:transparent;color:#666">æš‚æ— è®°å½•ï¼Œå®Œæˆä¸€æ¬¡è®­ç»ƒåä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œã€‚</li>';
    return;
  }
  records.forEach((r,i)=>{
    const li = document.createElement('li');
    const left = document.createElement('div');
    left.className = 'record-meta';
    // ç­‰çº§æ˜¾ç¤º
    const rating = evaluate(mode, r.time);
    left.innerHTML = `<div><strong>${r.time.toFixed(2)}s</strong>  <span style="color:${rating.color};font-weight:700">${rating.text}</span></div><div class="small">${r.date}</div>`;
    const right = document.createElement('div');
    const del = document.createElement('button');
    del.className = 'del';
    del.textContent = 'åˆ é™¤';
    del.onclick = ()=> deleteRecordByIdx(mode, findRecordIndex(mode, r.ts));
    right.appendChild(del);
    li.appendChild(left); li.appendChild(right);
    list.appendChild(li);
  });
}

/* æ‰¾åˆ°è®°å½•åœ¨åŸæ•°ç»„çš„ä¸‹æ ‡ï¼ˆæ ¹æ® tsï¼‰ */
function findRecordIndex(m, ts){
  if(!leaderboards[m]) return -1;
  return leaderboards[m].findIndex(x=>x.ts === ts);
}

/* =============== ç½®é¡¶ç»Ÿè®¡ï¼ˆæœ¬æ¨¡å¼æœ€ä½³ / ä»Šæ—¥æœ€ä½³ï¼‰ =============== */
function updateTopStats(){
  if(!mode){
    document.getElementById('best-all').textContent = '-';
    document.getElementById('best-today').textContent = '-';
    return;
  }
  const arr = leaderboards[mode] || [];
  if(arr.length === 0){
    document.getElementById('best-all').textContent = '-';
    document.getElementById('best-today').textContent = '-';
    return;
  }
  const allBest = Math.min(...arr.map(x=>x.time));
  const today = new Date().toLocaleDateString();
  const todayArr = arr.filter(x=>x.date === today);
  const todayBest = todayArr.length ? Math.min(...todayArr.map(x=>x.time)) : '-';
  document.getElementById('best-all').textContent = allBest.toFixed(2);
  document.getElementById('best-today').textContent = todayBest === '-' ? '-' : todayBest.toFixed(2);
}

/* =============== è¾…åŠ©å‡½æ•° =============== */
function randomColor(){
  const cs = ['#ffcccc','#ccffcc','#ccccff','#fff0b3','#ffd1dc','#e6f7ff','#e0ffe6'];
  return cs[Math.floor(Math.random()*cs.length)];
}

/* åˆå§‹åŒ–é¡µé¢ï¼šæ˜¾ç¤ºé»˜è®¤ï¼ˆæœªé€‰æ¨¡å¼ï¼‰ */
renderRecords();
updateTopStats();

</script>
</body>
</html>
